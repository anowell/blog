<!DOCTYPE html>
<html>
  <head>
        
      <title>Deep Style Wall</title>
    
    <meta name="author" content="Anthony Nowell">
    <meta name="description" content="How I created a photo wall of deep style art using a DeepFilter API.">
    
      <meta property="og:type" content="article" />
      <meta property="og:url" content="http://anowell.com/posts/deep-style-wall.html">
      <meta property="og:type" content="website">
      <meta property="og:title" content="Deep Style Wall" />
      <meta property="og:image" content="http://anowell.com/images/deep-style-wall/painting_walk-post_modern_thumb.jpg" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:site" content="@atnowell" />
      <meta name="twitter:title" content="Deep Style Wall" />
      <meta name="twitter:description" content="How I created a photo wall of deep style art using a DeepFilter API." />
      <meta name="twitter:image" content="http://anowell.com/images/deep-style-wall/painting_walk-post_modern_thumb.jpg" />
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto+Slab|Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/railscasts.min.css">
    

  </head>
  <body>
    <div style="position: relative;">
      <div class="cover no-print" style="background-image: url(/images/covers/trail_walk-post_modern.jpg); background-position: center;"></div>
    </div>
    <div class="top-nav no-print" style="position: relative; float:left; top:28px;">
      <a href="/"><i class="fa fa-chevron-circle-left"></i></a>
    </div>
    <div>
      <div class="container">
  <div class="post">
    <h2>Deep Style Wall</h2>
    <h6 style="margin-top: -10px;">2016-12-19</h6>
    <p>
      <p>Nearly a year ago, my wife covered a wall in photos of our family. When she went to rotate the photos, I claimed the old collection for my office at home - a much needed improvement.</p>
<p>A few weeks ago, my colleagues at Algorithmia cranked out a pretty sweet <a href="http://demos.algorithmia.com/deep-style/">Deep Style Demo</a> based on the <a href="https://algorithmia.com/algorithms/deeplearning/DeepFilter">DeepFilter algorithm</a> (hat tip to <a href="https://twitter.com/BesirKurtulmus">@BesirKurtulmus</a>). Immediately I hacked together a quick bash script to generate all 37 Deep Style variants of a single image. The full script is <a href="https://gist.github.com/anowell/386035fede097e4aa505102481f00517">here</a>, but at its core, it just loops through the filters and calls out to the <code>algo</code> CLI tool.</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;"># Now loop through filters
</span><span style="color:#b48ead;">for</span><span style="color:#c0c5ce;"> filter </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">$</span><span style="color:#bf616a;">FILTERS</span><span style="color:#c0c5ce;">; </span><span style="color:#b48ead;">do
</span><span style="color:#c0c5ce;">  </span><span style="color:#96b5b4;">echo </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Rendering with </span><span style="color:#c0c5ce;">$</span><span style="color:#bf616a;">filter</span><span style="color:#a3be8c;"> filter...</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">  </span><span style="color:#bf616a;">savePath</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">data://.my/temp/</span><span style="color:#c0c5ce;">$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">FNAME</span><span style="color:#c0c5ce;">%</span><span style="color:#a3be8c;">.</span><span style="color:#c0c5ce;">*</span><span style="color:#a3be8c;">}-</span><span style="color:#c0c5ce;">$</span><span style="color:#bf616a;">filter</span><span style="color:#a3be8c;">.jpg</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">  </span><span style="color:#8fa1b3;">algo</span><span style="color:#c0c5ce;"> run $</span><span style="color:#bf616a;">PROFILE_ARGS</span><span style="color:#c0c5ce;"> deeplearning/DeepFilter/0.5.7 \
</span><span style="color:#bf616a;">    -d </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">{</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">images</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">: [</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">$</span><span style="color:#bf616a;">IMAGE</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">], </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">savePaths</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">: [</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">$</span><span style="color:#bf616a;">savePath</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">], </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">filterName</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">: </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">$</span><span style="color:#bf616a;">filter</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">}</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">  </span><span style="color:#8fa1b3;">algo</span><span style="color:#c0c5ce;"> cp $</span><span style="color:#bf616a;">PROFILE_ARGS </span><span style="color:#c0c5ce;">$</span><span style="color:#bf616a;">savePath</span><span style="color:#c0c5ce;"> .
</span><span style="color:#b48ead;">done
</span></pre>
<p>So while staring at my wall of photos one day, I felt I should take it a step further and have a wall of DeepFilter generated photos. A new project was born!</p>
<h3>Step 1: Curating</h3>
<p>First I needed photos. Sadly our photos aren't particularly well-organized (I'm still holding out for the holy grail of photo storage solutions), so I had to scour through both my wife's and my Google Drive and One Drive accounts to gather a bunch of photos to use. I don't usually enjoy multi-hour long sessions of flipping through photo albums, so I hastily selected a wide variety images that I thought would be interesting. In the end, I had curated 111 photos for the next phase.</p>
<h3>Step 2: Generating DeepStyle Art</h3>
<p>At 37 filters and 111 photos, using my previous script would generate 4,107 images. But I didn't really want to generate 37 variants of each image because, once again, skimming through another 4k photos isn't really my thing, but also because of the <a href="https://en.wikipedia.org/wiki/The_Paradox_of_Choice">Paradox of Choice</a>. Also, the previous script completely ignores the DeepFilter API support for batching multiple images into a single request so using it to generate 4,107 images would have cost near $30.</p>
<p>So I decided to rewind and write a new script that:</p>
<ol>
<li>Randomly pick 4 filters for each image while still evenly distributing filters across all images</li>
<li>Batch multiple images into a single request (per-filter)</li>
</ol>
<p>This was a little beyond the scope of a simple bash script (and too much of a one-off hack to justify writing in Rust), so I rekindled my love of ruby. A simple version of the random filter selection looks like this:</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PER_IMAGE = </span><span style="color:#d08770;">4
</span><span style="color:#c0c5ce;">filter_set = []
</span><span style="color:#c0c5ce;">filter_paths = {}
</span><span style="color:#c0c5ce;">all_paths.shuffle.each </span><span style="color:#b48ead;">do </span><span style="color:#c0c5ce;">|</span><span style="color:#bf616a;">p</span><span style="color:#c0c5ce;">|
</span><span style="color:#c0c5ce;">  </span><span style="color:#ebcb8b;">PER_IMAGE</span><span style="color:#c0c5ce;">.times </span><span style="color:#b48ead;">do
</span><span style="color:#c0c5ce;">    filter_set = </span><span style="color:#ebcb8b;">ALL_FILTERS</span><span style="color:#c0c5ce;">.shuffle </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> filter_set.empty?
</span><span style="color:#c0c5ce;">    f = filter_set.pop
</span><span style="color:#c0c5ce;">    filter_paths[f] ||= []
</span><span style="color:#c0c5ce;">    filter_paths[f] &lt;&lt; </span><span style="color:#96b5b4;">p
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></pre>
<p>This creates a <code>Hash</code> that maps each filter to a set of image paths (random pairings) while ensuring that each filter is used approximately the same number of times overall. I added a quick snippet to pre-upload all my images to the Algorithmia Data API:</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">data_dir = client.dir(&quot;</span><span style="color:#a3be8c;">data://.my/test</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">all_paths.each </span><span style="color:#b48ead;">do </span><span style="color:#c0c5ce;">|</span><span style="color:#bf616a;">p</span><span style="color:#c0c5ce;">|
</span><span style="color:#c0c5ce;">  basename = </span><span style="color:#ebcb8b;">Pathname</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">new</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">p</span><span style="color:#c0c5ce;">).basename
</span><span style="color:#c0c5ce;">  data_file = data_dir.file(basename)
</span><span style="color:#c0c5ce;">  data_dir.put_file(</span><span style="color:#96b5b4;">p</span><span style="color:#c0c5ce;">)
</span><span style="color:#b48ead;">end
</span></pre>
<p>And now I was ready to generate 444 images with just 37 API requests (12 images per request):</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">filter_paths.each </span><span style="color:#b48ead;">do </span><span style="color:#c0c5ce;">|</span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">paths</span><span style="color:#c0c5ce;">|
</span><span style="color:#c0c5ce;">  src_paths = paths.map </span><span style="color:#b48ead;">do </span><span style="color:#c0c5ce;">|</span><span style="color:#bf616a;">p</span><span style="color:#c0c5ce;">|
</span><span style="color:#c0c5ce;">    basename = </span><span style="color:#ebcb8b;">Pathname</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">new</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">p</span><span style="color:#c0c5ce;">).basename
</span><span style="color:#c0c5ce;">    data_dir.file(basename).data_uri
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">  save_paths = paths.map </span><span style="color:#b48ead;">do </span><span style="color:#c0c5ce;">|</span><span style="color:#bf616a;">p</span><span style="color:#c0c5ce;">|
</span><span style="color:#c0c5ce;">    &quot;</span><span style="color:#ab7967;">#{</span><span style="color:#a3be8c;">data_dir_uri</span><span style="color:#ab7967;">}</span><span style="color:#a3be8c;">/</span><span style="color:#ab7967;">#{</span><span style="color:#a3be8c;">generated_filename(</span><span style="color:#96b5b4;">p</span><span style="color:#a3be8c;">, filter)</span><span style="color:#ab7967;">}</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">  data = {
</span><span style="color:#c0c5ce;">    </span><span style="color:#a3be8c;">images:</span><span style="color:#c0c5ce;"> src_paths,
</span><span style="color:#c0c5ce;">    </span><span style="color:#a3be8c;">savePaths:</span><span style="color:#c0c5ce;"> save_paths,
</span><span style="color:#c0c5ce;">    </span><span style="color:#a3be8c;">filterName:</span><span style="color:#c0c5ce;"> filter,
</span><span style="color:#c0c5ce;">  }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">  </span><span style="color:#96b5b4;">puts </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#a3be8c;">### Rendering </span><span style="color:#ab7967;">#{</span><span style="color:#a3be8c;">src_paths.length</span><span style="color:#ab7967;">}</span><span style="color:#a3be8c;"> images with </span><span style="color:#ab7967;">#{</span><span style="color:#a3be8c;">filter</span><span style="color:#ab7967;">}</span><span style="color:#a3be8c;"> filter...</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">  algo = client.algo(&#39;</span><span style="color:#a3be8c;">deeplearning/DeepFilter/0.5.7</span><span style="color:#c0c5ce;">&#39;)
</span><span style="color:#c0c5ce;">  algo.set_timeout(</span><span style="color:#d08770;">300</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">  resp = algo.pipe(data)
</span><span style="color:#c0c5ce;">  resp.result[&#39;</span><span style="color:#a3be8c;">savePaths</span><span style="color:#c0c5ce;">&#39;].each { |</span><span style="color:#bf616a;">p</span><span style="color:#c0c5ce;">| </span><span style="color:#96b5b4;">puts p </span><span style="color:#c0c5ce;">}
</span><span style="color:#b48ead;">end
</span></pre>
<p>A half hour later and I have 444 generated images including several gems:</p>
<div class="grid">
    <div class="col"><img src="/images/deep-style-wall/train_ride-colorful_dream_thumb.jpg"></div>
    <div class="col"><img src="/images/deep-style-wall/painting_walk-post_modern_thumb.jpg"></div>
    <div class="col"><img src="/images/deep-style-wall/buzz-crunch_paper_thumb.jpg"></div>
</div>
<h3>Step 3: Rinse and Repeat</h3>
<p>I quickly browsed the generated images, and selected my favorite of the 4 generated variants of each photo. For the cases where I didn't like any of the 4 choices, I took the original and set it aside for repeating the process. I selected about 70 generated images from the first batch, so I had about 40 images that I wanted to try on a few more filters. I bumped the <code>PER_IMAGE</code> number to 10, added more logic to avoid repeating image-filter pairings, and removed a few filters that never appealed to me. The next run of the script with 40 photos generated another 400 images. I manage to pick out another 25 photos, and then accepted the remaining images aren't well-suited to any of the filters*.</p>
<p>The full script used during this process is available <a href="https://gist.github.com/anowell/fd8cd6706b6c16080f09e67765e6915d">here</a>.</p>
<p>* <em>I actually repeated this process one more time using all filters on the final 15 images, but I only kept 2 of the images from that batch, so it seems that subsequent iterations have diminishing returns.</em></p>
<h3>Step 4: Print</h3>
<p>I did a final round of curating the generated images and decided on 70 images for printing. A couple images earned 8x10 treatment, and I decided to experiment with printing 2 of the images on canvas. In the end, I spent about $2 in Algorithmia credits, $9 in prints at Sam's Club, and $30 for a pair of 8x10 framed canvas prints at a local print shop.</p>
<p>And now 23 filters are represented on my Deep Style Wall.</p>
<img src="/images/deep-style-wall/photo-wall.jpg">

    </p>

  </div>
</div>

<hr>

<div class="container" style="text-align: center;">
  <p><i>-- by Anthony Nowell --</i></p>

  <p>
    Let me know what you think, or share it yourself:
    <a href="https://twitter.com/share?text=Deep Style Wall via @atnowell&url=http://anowell.com/posts/deep-style-wall.html" target="_blank"><i class="fa fa-twitter"></i> Tweet @atnowell</a>
  </p>
</div>

    </div>

    <script src="/js/main.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

    <script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-89616131-1', 'auto');
	ga('send', 'pageview');
</script>

  </body>
</html>
